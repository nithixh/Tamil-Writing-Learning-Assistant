{% extends "layout.html" %}

{% block title %}{{ lesson.title }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row justify-content-center">
        <!-- Main content -->
        <div class="col-lg-8 col-xl-7 me-lg-3">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-0 text-center py-4">
                    <h2 class="fw-bold mb-0">{{ lesson.title }}</h2>
                </div>
                <div class="card-body px-4 py-4">

                    {% if lesson.content_type == 'translation' %}
                        <div class="text-center mb-4">
                            <h5 class="fw-semibold text-muted">Translate to Tamil:</h5>
                            <p class="display-6 text-primary fw-bold">{{ content.en }}</p>
                        </div>
                        <p class="text-center text-muted mb-4">
                            ‚úç Write the Tamil translation in the box below
                        </p>
                    {% else %}
                    <div class="text-center mb-4">
                        <h5 class="fw-semibold text-muted">Write this {{ lesson.content_type }}:</h5>
                        <p class="display-1 fw-bold text-primary" id="lessonText">{{ content }}</p>
                        <button id="playAudioBtn" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <audio id="ttsAudio" src="{{ url_for('static', filename='audio/lesson' ~ lesson.id ~ '.wav') }}"></audio>
                        <div id="audioStatus" class="mt-2 text-muted"></div>
                    </div>
<script>
document.getElementById('playAudioBtn').addEventListener('click', async () => {
    const audio = document.getElementById('ttsAudio');
    try {
        await audio.play();
        document.getElementById('audioStatus').textContent = 'Playing audio...';
        audio.onended = () => {
            document.getElementById('audioStatus').textContent = 'Audio playback finished.';
        };
    } catch (err) {
        console.error('Audio playback error:', err);
        document.getElementById('audioStatus').textContent = 'Failed to play audio.';
    }
});
</script>

                    {% endif %}

                    <!-- Writing Canvas -->
                    <div class="writing-area bg-light rounded-3 shadow-sm mb-4" style="height: 300px; position: relative;">
                        <canvas id="templateCanvas"></canvas>
                        <canvas id="writingCanvas"></canvas>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-center gap-3 mb-3">
                        <button id="resetBtn" class="btn btn-outline-secondary px-4">
                            <i class="fas fa-undo me-1"></i> Reset
                        </button>
                        <button id="submitBtn" class="btn btn-primary px-4">
                            <i class="fas fa-check me-1"></i> Submit
                        </button>
                    </div>

                    <!-- Feedback -->
                    <div id="feedbackArea" class="alert alert-info d-none text-center rounded-3 shadow-sm">
                        <div id="feedbackContent"></div>
                    </div>

                    <!-- Progress -->
                    {% if lesson.attempts > 0 %}
                    <div class="mt-4 p-4 bg-light rounded-3 shadow-sm">
                        <h6 class="fw-semibold mb-3">Your Best Progress:</h6>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar bg-success fw-semibold"
                                 role="progressbar" 
                                 style="width: {{ (lesson.highest_accuracy or 0) * 100 }}%;" 
                                 aria-valuenow="{{ (lesson.highest_accuracy or 0) * 100 }}" 
                                 aria-valuemin="0" aria-valuemax="100">
                                 {{ "%.1f"|format((lesson.highest_accuracy or 0) * 100) }}%
                            </div>
                        </div>
                        <p class="small text-muted mb-0">
                            Attempts: {{ lesson.attempts }} | Successful: {{ lesson.successful_attempts }}
                        </p>
                    </div>
                    {% endif %}

                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="text-center mb-4">
                <a href="/lessons" class="btn btn-outline-primary me-2">
                    <i class="fas fa-arrow-left me-1"></i> Back to Lessons
                </a>
                {% if next_lesson_id %}
                    <a href="/lesson/{{ next_lesson_id }}" class="btn btn-success">
                        Next Lesson <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- GIF Card -->
        <div class="col-lg-3 col-xl-3">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white text-center fw-semibold">
                    Stroke Guide
                </div>
                <div class="card-body text-center">
                    <img src="{{ url_for('static', filename='gifs/{}.gif'.format(lesson.id)) }}" 
                        alt="Lesson {{ lesson.id }} guide" 
                        class="img-fluid rounded">
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/canvas.js"></script>
<script src="https://code.responsivevoice.org/responsivevoice.js?key=YOUR_KEY"></script>
<script>
    const lessonId = {{ lesson.id }};
    const templateText = `{% if lesson.content_type == 'translation' %}{{ content.ta }}{% else %}{{ content }}{% endif %}`;

    const canvasManager = new CanvasManager(
        'writingCanvas',
        'templateCanvas',
        'resetBtn',
        'submitBtn',
        'feedbackArea',
        'feedbackContent',
        lessonId,
        templateText
    );
    document.getElementById('playAudioBtn').addEventListener('click', async () => {
    const audio = document.getElementById('ttsAudio');
    try {
        await audio.play();
        document.getElementById('audioStatus').textContent = 'Playing audio...';
        audio.onended = () => {
            document.getElementById('audioStatus').textContent = 'Audio playback finished.';
        };
    } catch (err) {
        console.error('Audio playback error:', err);
        document.getElementById('audioStatus').textContent = 'Failed to play audio.';
    }
});


</script>
{% endblock %}
